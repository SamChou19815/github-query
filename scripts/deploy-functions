#!/bin/bash

# The workaround script to overcome Firebase CLI's inability
# to fetch code outside of functions folder.

# This script should be run from project root like
# ./scripts/deploy-functions [project name]

set -x

# Step 1: Build All Projects

cd core
yarn
yarn build
cd ../

cd backend
yarn
yarn build
cd ../

cd functions
yarn
yarn build
cd ../

# Step 2: Setup mirror folders for deployments

mkdir temp
mkdir temp/functions
mkdir temp/functions/core
mkdir temp/functions/backend

# Copy Generated Code
cp functions/*.json functions/*.js temp/functions/
cp -r core/*.json core/*.js temp/functions/core/
cp -r backend/*.json backend/*.js temp/functions/backend/

# Copy package.json

echo '{}' >temp/firebase.json

sed -i -e 's/..\/backend/backend/g' temp/functions/package.json

cd temp/functions
yarn
cd ../
firebase deploy --only functions
cd ../
rm -rf temp
